blueprint:
  name: Bluetooth MAC → Person Location Attribution
  description: >
    Assigns device_tracker locations based on Bluetooth MAC connections to
    person source devices. Person priority is determined by input order.
    Each MAC maps to its own target device_tracker.
    Triggers on state changes for efficient, real-time updates.
  domain: automation

  input:
    persons:
      name: Persons (priority order)
      description: First person has highest priority
      selector:
        entity:
          domain: person
          multiple: true

    bluetooth_macs:
      name: Bluetooth MAC Addresses
      description: Ordered list of MACs (AA:BB:CC:DD:EE:FF)
      selector:
        object:

    target_device_trackers:
      name: Target Device Trackers
      description: Ordered list — must match MAC order
      selector:
        object:

mode: single
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input persons
    attribute: latitude
  - platform: state
    entity_id: !input persons
    attribute: longitude
  - platform: homeassistant
    event: start

variables:
  people: !input persons
  macs: !input bluetooth_macs
  targets: !input target_device_trackers

  match: >
    {%- for i in range(macs | length) -%}
      {%- set mac = macs[i] | lower -%}
      {%- for person in people -%}
        {%- set source = state_attr(person, 'source') -%}
        {%- if source -%}
          {%- set sensors =
            device_entities(device_id(source))
            | select('match', '.*bluetooth_connection$')
            | list -%}
          {%- if sensors | length > 0 -%}
            {%- set devices =
              state_attr(sensors | first, 'connected_paired_devices') or [] -%}
            {%- if mac in (devices | join | lower) -%}
              {{ person }}|{{ mac }}|{{ targets[i] }}
              {%- break -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if match is defined and match | length > 0 -%}{%- break -%}{%- endif -%}
    {%- endfor -%}

condition: []

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ match | length > 0 }}"
        sequence:
          - variables:
              person: "{{ match.split('|')[0] }}"
              mac: "{{ match.split('|')[1] }}"
              target: "{{ match.split('|')[2] }}"
              lat: "{{ state_attr(person, 'latitude') }}"
              lon: "{{ state_attr(person, 'longitude') }}"
              acc: "{{ state_attr(person, 'gps_accuracy') or 50 }}"

          - service: device_tracker.see
            data:
              dev_id: "{{ target.split('.')[-1] }}"
              gps:
                - "{{ lat }}"
                - "{{ lon }}"
              gps_accuracy: "{{ acc }}"
              source_type: gps
